First time telnet
=================

Today we will experiment with simple telnet connection.

Why bother with an outdated and insecure protocol ?
The reason for doing that is it will give us a second
type of device connectivity. We will use it later on
when creating a type that will abstract the protocol
details away from us, allowing to use either, which
will also give additional ways to test the robustness
of our applications that will use this class.

This session assumes you have an LXD container with Rust 
installed from the our previous session.

Also, this tutorial will be a little bit more fast-paced
in places. Hopefully you can follow - I try to make the
commits small and describe what I am doing.

There are a couple of books that you can consult
if you are interested in the particular details of the language:

- https://www.amazon.com/Programming-Rust-Fast-Systems-Development/dp/1491927283
- https://doc.rust-lang.org/book/

Let's create the today's project:

```
ubuntu@ts-netops:~$ cargo new --bin ts-netops-simple-telnet
     Created binary (application) `ts-netops-simple-telnet` package
ubuntu@ts-netops:~$ 
ubuntu@ts-netops:~$ cd ts-netops-simple-telnet
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
    Finished dev [unoptimized + debuginfo] target(s) in 0.26s
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git add Cargo.* src/
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "First project commit"
[master (root-commit) 3b01858] First project commit
 3 files changed, 17 insertions(+)
 create mode 100644 Cargo.lock
 create mode 100644 Cargo.toml
 create mode 100644 src/main.rs
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Let's add the telnet implementation from https://docs.rs/telnet/0.1.0/telnet/struct.Telnet.html:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/Cargo.lock b/Cargo.lock
index 994e14d..6137b1a 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1,5 +1,14 @@
 # This file is automatically @generated by Cargo.
 # It is not intended for manual editing.
+[[package]]
+name = "telnet"
+version = "0.1.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3eb466fac9217be30197774bcfd417f711dcd730d9cc6d7ea4ac85728c0cb9d5"
+
 [[package]]
 name = "ts-netops-simple-telnet"
 version = "0.1.0"
+dependencies = [
+ "telnet",
+]
diff --git a/Cargo.toml b/Cargo.toml
index d06c878..01d625a 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -7,3 +7,4 @@ edition = "2018"
 # See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
 
 [dependencies]
+telnet = "*"
diff --git a/src/main.rs b/src/main.rs
index e7a11a9..e9767da 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -1,3 +1,14 @@
+extern crate telnet;
+use telnet::Telnet;
+
 fn main() {
-    println!("Hello, world!");
+    let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
+    let tcp_target = format!("{}:23", ts_netops_host);
+
+    let mut connection =
+        Telnet::connect(tcp_target, 256).expect("Couldn't connect to the server...");
+    loop {
+        let event = connection.read().expect("Read Error");
+        println!("{:?}", event);
+    }
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Add first telnet code"
[master f239e53] Add first telnet code
 3 files changed, 24 insertions(+), 3 deletions(-)
 rewrite src/main.rs (68%)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
    Finished dev [unoptimized + debuginfo] target(s) in 0.35s
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
Data([67, 13, 10, 35, 35, 35, 35, 35, ..... ])
Data([35, 13, 10, 35, ..... ])
...
Data([35, 35, 13, 10, 13, 10, 13, 10, 85, 115, 101, 114, 32, 65, 99, 99, 101, 115, 115, 32, 86, 101, 114, 105, 102, 105, 99, 97, 116, 105, 111, 110, 13, 10, 13, 10, 85, 115, 101, 114, 110, 97, 109, 101, 58, 32])

```


What is going on here ? Two things. First, telnet includes not just
the user data, but also the option negotiation - and the library is low
level enough to expose it.

Second: The type for the data, for the transparency sake, is defined as u8 -
thus it is printed as numbers, rather than characters.
Why not strings, you ask ? Well, correct strings implementation is a rather
delicate matter - and there are many different string types in the world,
all slightly incompatible.

For our scenario, we will just make a lossy conversion into UTF-8 - after all,
most probably ASCII is as much as there is going to be going over
the interactive shell, and even the UTF-8 is a good stretch of imagination.

``` 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index e9767da..32cec78 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -8,7 +8,16 @@ fn main() {
     let mut connection =
         Telnet::connect(tcp_target, 256).expect("Couldn't connect to the server...");
     loop {
+        use telnet::TelnetEvent;
         let event = connection.read().expect("Read Error");
-        println!("{:?}", event);
+        match &event {
+            TelnetEvent::Data(bytes) => {
+                let string = String::from_utf8_lossy(&bytes);
+                println!("Data: {}", &string);
+            }
+            _ => {
+                println!("{:?}", &event);
+            }
+        }
     }
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Print strings instead of bytes"
[master e753e4b] Print strings instead of bytes
 1 file changed, 10 insertions(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
    Finished dev [unoptimized + debuginfo] target(s) in 0.29s
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
Data: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               #
Data: #
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           #
Data: #
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
############################################################
Data: ##


User Access Verification

Username: 
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

This is much better, but it reveals that using telnet will in fact
be quite a bit more complicated than SSH - we will need to perform
the login process before we request the command..

Also - we notice that the data comes in chunks, so we will need to have
a kind of buffer to collect it before passing on to the user.

Let's make a first sketch of what it all would look like:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/Cargo.lock b/Cargo.lock

 *** NOTE: this diff is rather big so I omit it in this list.

diff --git a/Cargo.toml b/Cargo.toml
index 01d625a..da7f28c 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -8,3 +8,4 @@ edition = "2018"
 
 [dependencies]
 telnet = "*"
+regex = "*"
diff --git a/src/main.rs b/src/main.rs
index 32cec78..55dd99d 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -1,19 +1,44 @@
+extern crate regex;
 extern crate telnet;
+use regex::Regex;
 use telnet::Telnet;
 
+enum LoginState {
+    Initial,
+    SentUsername,
+    SentPassword,
+    Established,
+}
+
 fn main() {
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
     let tcp_target = format!("{}:23", ts_netops_host);
 
     let mut connection =
         Telnet::connect(tcp_target, 256).expect("Couldn't connect to the server...");
+
+    let mut data_buffer = String::new();
+    let mut login_state = LoginState::Initial;
+    let username_regex = Regex::new(r"^[Uu]sername:").unwrap();
+
     loop {
         use telnet::TelnetEvent;
         let event = connection.read().expect("Read Error");
         match &event {
             TelnetEvent::Data(bytes) => {
                 let string = String::from_utf8_lossy(&bytes);
-                println!("Data: {}", &string);
+                data_buffer.push_str(&string);
+                match login_state {
+                    LoginState::Initial => {
+                        println!("In initial state");
+                        if username_regex.is_match(&data_buffer) {
+                            println!("Matchched username prompt! Data buffer: {}", &data_buffer);
+                        }
+                    }
+                    _ => {
+                        println!("Other login state. data buffer: {}", &data_buffer);
+                    }
+                }
             }
             _ => {
                 println!("{:?}", &event);
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

So, you can see that rather than printing and discarding the data,
now I create a mutable buffer, and append the data each time I receive it.

Also I created a new enum type, which will represent the state of
the telnet login session; and for now a regex that we would expect to
match the login prompt. Note, that we are doing 
a case-insensitive match on the first letter. This will save us some
testing cycles in case the prompt is all-lowercase.

Let's commit and run this code:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Trial regex matching and state"
[master f7320f8] Trial regex matching and state
 3 files changed, 76 insertions(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
In initial state
In initial state
In initial state
In initial state
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

The regex obviously does not match. Why ? By default it is considered as
single-line. If we did not have the banner, it might have matched, but
given that we do, it fails to do so.

Let's fix that:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 55dd99d..a1c04cf 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -19,7 +19,7 @@ fn main() {
 
     let mut data_buffer = String::new();
     let mut login_state = LoginState::Initial;
-    let username_regex = Regex::new(r"^[Uu]sername:").unwrap();
+    let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
 
     loop {
         use telnet::TelnetEvent;
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Fix the multiline regex match"
[master 41b4a27] Fix the multiline regex match
 1 file changed, 1 insertion(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

When we compile and run it, we see it correctly matches now:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
In initial state
In initial state
In initial state
In initial state
Matchched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
^C
```

Now we will need to send the password, change the state, and clear out
the part of the buffer before the end of the match.
But to do so we should know where the end of the match is...
So a little tweak to the use of regex is in order.

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index a1c04cf..7834e86 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -12,6 +12,7 @@ enum LoginState {
 
 fn main() {
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
+    let ts_netops_user = std::env::var("TS_NETOPS_USER").unwrap();
     let tcp_target = format!("{}:23", ts_netops_host);
 
     let mut connection =
@@ -31,8 +32,13 @@ fn main() {
                 match login_state {
                     LoginState::Initial => {
                         println!("In initial state");
-                        if username_regex.is_match(&data_buffer) {
+                        let maybe_user_match = username_regex.find(&data_buffer);
+                        if let Some(user_match) = maybe_user_match {
                             println!("Matchched username prompt! Data buffer: {}", &data_buffer);
+                            connection.write(&format!("{}\n", &ts_netops_user).as_bytes());
+                            let (_, remainder) = data_buffer.split_at(user_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::SentUsername;
                         }
                     }
                     _ => {
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Send the username and change state"
[master 66ec684] Send the username and change state
 1 file changed, 7 insertions(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
In initial state
In initial state
In initial state
In initial state
Matchched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
Other login state. data buffer:  a
Other login state. data buffer:  ay
Other login state. data buffer:  ay
Password: 
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

It would seem nice to directly print the state value for debugging,
rather than just refer to it as "other":

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 7834e86..63753e5 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -42,7 +42,7 @@ fn main() {
                         }
                     }
                     _ => {
-                        println!("Other login state. data buffer: {}", &data_buffer);
+                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
                 }
             }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
error[E0277]: `LoginState` doesn't implement `std::fmt::Debug`
  --> src/main.rs:45:72
   |
45 |                         println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
   |                                                                        ^^^^^^^^^^^^ `LoginState` cannot be formatted using `{:?}`
   |
   = help: the trait `std::fmt::Debug` is not implemented for `LoginState`
   = note: add `#[derive(Debug)]` or manually implement `std::fmt::Debug`
   = note: required because of the requirements on the impl of `std::fmt::Debug` for `&LoginState`
   = note: required by `std::fmt::Debug::fmt`
   = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)

error: aborting due to previous error

For more information about this error, try `rustc --explain E0277`.
error: could not compile `ts-netops-simple-telnet`.

To learn more, run the command again with --verbose.
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

This error occurs because the format specifier "{:?}" requires 
a special trait (if you are familiar with Ruby, think of it as a kind
of mixin), which shows us the debug-oriented representation of
the object.

#[derive(Debug)] is a macro invocation, which allows to let compiler
automatically create the definition of this trait, if all of the
dependent types already implement this trait, or if the type is
a basic one (like now).

So, we can simply follow what the compiler tells us to do, and we
see that it will compile and run fine now:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 7834e86..93d4941 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -3,6 +3,7 @@ extern crate telnet;
 use regex::Regex;
 use telnet::Telnet;
 
+#[derive(Debug)]
 enum LoginState {
     Initial,
     SentUsername,
@@ -42,7 +43,7 @@ fn main() {
                         }
                     }
                     _ => {
-                        println!("Other login state. data buffer: {}", &data_buffer);
+                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
                 }
             }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
warning: variant is never constructed: `SentPassword`
  --> src/main.rs:10:5
   |
10 |     SentPassword,
   |     ^^^^^^^^^^^^
   |
   = note: `#[warn(dead_code)]` on by default

warning: variant is never constructed: `Established`
  --> src/main.rs:11:5
   |
11 |     Established,
   |     ^^^^^^^^^^^

warning: unused `std::result::Result` that must be used
  --> src/main.rs:39:29
   |
39 | ...                   connection.write(&format!("{}\n", &ts_netops_user).as_bytes());
   |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: `#[warn(unused_must_use)]` on by default
   = note: this `Result` may be an `Err` variant, which should be handled

    Finished dev [unoptimized + debuginfo] target(s) in 0.93s
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Print the state explicitly for debugging"
[master 37c61ac] Print the state explicitly for debugging
 1 file changed, 2 insertions(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
In initial state
In initial state
In initial state
In initial state
Matchched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
Other state: SentUsername. data buffer:  a
Other state: SentUsername. data buffer:  ay
Other state: SentUsername. data buffer:  ay
Password: 
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

We can mimic the sending of the password based on the username:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 93d4941..0cf00a7 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -14,6 +14,7 @@ enum LoginState {
 fn main() {
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
     let ts_netops_user = std::env::var("TS_NETOPS_USER").unwrap();
+    let ts_netops_pass = std::env::var("TS_NETOPS_PASS").unwrap();
     let tcp_target = format!("{}:23", ts_netops_host);
 
     let mut connection =
@@ -22,6 +23,7 @@ fn main() {
     let mut data_buffer = String::new();
     let mut login_state = LoginState::Initial;
     let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
+    let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
 
     loop {
         use telnet::TelnetEvent;
@@ -42,6 +44,16 @@ fn main() {
                             login_state = LoginState::SentUsername;
                         }
                     }
+                    LoginState::SentUsername => {
+                        let maybe_password_match = password_regex.find(&data_buffer);
+                        if let Some(password_match) = maybe_password_match {
+                            println!("Matchched password prompt! Data buffer: {}", &data_buffer);
+                            connection.write(&format!("{}\n", &ts_netops_pass).as_bytes());
+                            let (_, remainder) = data_buffer.split_at(password_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::SentPassword;
+                        }
+                    }
                     _ => {
                         println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Implement sending the password"
[master 8b0613a] Implement sending the password
 1 file changed, 12 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
In initial state
In initial state
In initial state
In initial state
Matchched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
Matchched password prompt! Data buffer:  ay
Password: 
Other state: SentPassword. data buffer:  

003-X03-S0457#
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

We got to prompt! We should match on it, change the state
to "Established" and break out of the initial login loop.
Also, to save ourselves the hassle of dealing with the "---More---"
prompt, we should issue "terminal length 0" command before anything
else.

This will also warrant adding a new state - "ReadingOutput", which
the connection will have while reading the output and awaiting for the
privileged exec prompt:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 0cf00a7..d2bcac9 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -9,6 +9,7 @@ enum LoginState {
     SentUsername,
     SentPassword,
     Established,
+    ReadingOutput
 }
 
 fn main() {
@@ -24,6 +25,7 @@ fn main() {
     let mut login_state = LoginState::Initial;
     let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
     let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
+    let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z]+)#").unwrap();
 
     loop {
         use telnet::TelnetEvent;
@@ -32,12 +34,13 @@ fn main() {
             TelnetEvent::Data(bytes) => {
                 let string = String::from_utf8_lossy(&bytes);
                 data_buffer.push_str(&string);
+                println!("State: {:?}. data buffer: '{}'", &login_state, &data_buffer);
                 match login_state {
                     LoginState::Initial => {
                         println!("In initial state");
                         let maybe_user_match = username_regex.find(&data_buffer);
                         if let Some(user_match) = maybe_user_match {
-                            println!("Matchched username prompt! Data buffer: {}", &data_buffer);
+                            println!("Matched username prompt! Data buffer: {}", &data_buffer);
                             connection.write(&format!("{}\n", &ts_netops_user).as_bytes());
                             let (_, remainder) = data_buffer.split_at(user_match.end());
                             data_buffer = remainder.to_string();
@@ -47,13 +50,57 @@ fn main() {
                     LoginState::SentUsername => {
                         let maybe_password_match = password_regex.find(&data_buffer);
                         if let Some(password_match) = maybe_password_match {
-                            println!("Matchched password prompt! Data buffer: {}", &data_buffer);
+                            println!("Matched password prompt! Data buffer: {}", &data_buffer);
                             connection.write(&format!("{}\n", &ts_netops_pass).as_bytes());
                             let (_, remainder) = data_buffer.split_at(password_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::SentPassword;
                         }
                     }
+                    LoginState::SentPassword => {
+                        let maybe_privexec_match = privexec_regex.find(&data_buffer);
+                        if let Some(privexec_match) = maybe_privexec_match {
+                            println!("Matched privexec prompt! Session is open!");
+                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::Established;
+                            /* Session established */
+                            break;
+                        }
+                    }
+                    _ => {
+                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
+                    }
+                }
+            }
+            _ => {
+                println!("{:?}", &event);
+            }
+        }
+    }
+    println!("Showtime!");
+    connection.write(b"term len 0\n");
+    login_state = LoginState::ReadingOutput;
+
+    loop {
+        use telnet::TelnetEvent;
+        let event = connection.read().expect("Read Error");
+        match &event {
+            TelnetEvent::Data(bytes) => {
+                let string = String::from_utf8_lossy(&bytes);
+                data_buffer.push_str(&string);
+                match login_state {
+                    LoginState::ReadingOutput => {
+                        let maybe_privexec_match = privexec_regex.find(&data_buffer);
+                        if let Some(privexec_match) = maybe_privexec_match {
+                            println!("Matched privexec prompt! Data buffer: {}", &data_buffer);
+                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::Established;
+                            break;
+                        }
+
+                    }
                     _ => {
                         println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Issue 'term len 0' at the start of successful session"
[master f77f13f] Issue 'term len 0' at the start of successful session
 1 file changed, 49 insertions(+), 2 deletions(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet 
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               #'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           #'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
############################################################'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: '
In initial state
Matched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
State: SentUsername. data buffer: ' a'
State: SentUsername. data buffer: ' ay'
State: SentUsername. data buffer: ' ay
Password: '
Matched password prompt! Data buffer:  ay
Password: 
State: SentPassword. data buffer: ' 

003-X03-S0457#'
Matched privexec prompt! Session is open!
Showtime!
Matched privexec prompt! Data buffer: term len 0
003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

You may have noticed I added an extra debug println.. We will clean them
up later.

Finally it is time to add the retrieval of the command:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index d2bcac9..2b68265 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -16,6 +16,8 @@ fn main() {
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
     let ts_netops_user = std::env::var("TS_NETOPS_USER").unwrap();
     let ts_netops_pass = std::env::var("TS_NETOPS_PASS").unwrap();
+    let command_to_run = std::env::args().nth(1).unwrap();
+
     let tcp_target = format!("{}:23", ts_netops_host);
 
     let mut connection =
@@ -111,4 +113,37 @@ fn main() {
             }
         }
     }
+
+    connection.write(&format!("{}\n", command_to_run).as_bytes());
+    login_state = LoginState::ReadingOutput;
+
+    loop {
+        use telnet::TelnetEvent;
+        let event = connection.read().expect("Read Error");
+        match &event {
+            TelnetEvent::Data(bytes) => {
+                let string = String::from_utf8_lossy(&bytes);
+                data_buffer.push_str(&string);
+                match login_state {
+                    LoginState::ReadingOutput => {
+                        let maybe_privexec_match = privexec_regex.find(&data_buffer);
+                        if let Some(privexec_match) = maybe_privexec_match {
+                            println!("Matched privexec prompt! Data buffer: {}", &data_buffer);
+                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::Established;
+                            break;
+                        }
+
+                    }
+                    _ => {
+                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
+                    }
+                }
+            }
+            _ => {
+                println!("{:?}", &event);
+            }
+        }
+    }
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "add the retrieval of the command"
[master 89f8d84] add the retrieval of the command
 1 file changed, 35 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
Negotiation(Will, Echo)
Negotiation(Will, SuppressGoAhead)
Negotiation(Do, TTYPE)
Negotiation(Do, NAWS)
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               #'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           #'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
############################################################'
In initial state
State: Initial. data buffer: 'C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: '
In initial state
Matched username prompt! Data buffer: C
##############################################################
##               Hostname: 003-X03-S0457                    ##
##                                                          ##
##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
##                                                          ##
##     All sessions to this device are being monitored.     ##
##     If unauthorized access is detected, your address     ##
##     will be logged and the authorities will be           ##
##     notified to take appropriate actions.                ## 
##                                                          ##
##                                                          ##
##############################################################


User Access Verification

Username: 
State: SentUsername. data buffer: ' a'
State: SentUsername. data buffer: ' ay'
State: SentUsername. data buffer: ' ay
Password: '
Matched password prompt! Data buffer:  ay
Password: 
State: SentPassword. data buffer: ' 

003-X03-S0457#'
Matched privexec prompt! Session is open!
Showtime!
Matched privexec prompt! Data buffer: term len 0
003-X03-S0457#
Matched privexec prompt! Data buffer: who
    Line       User       Host(s)              Idle       Location
*  1 vty 0     ay         idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Finally, we got the output of the command. It took quite an effort!
However, the current code that we have, has several bugs:

1) The login sequence may have just the "Password:" prompt without the
username, or not have any password at all (not that it is a good idea
to do, but our code must be correct).

2) The code does not handle the write error - you probably noticed
that the "cargo build" compiles about the write() ignoring the error result.

3) There is a lot of duplicate code and noisy debug outputs. It's ok
to have them when we are prototyping like this, but later on we will
need to handle them better.


Let's take care of (3) first. For this, we will use a crate called "env_logger"
(https://docs.rs/env_logger/0.7.1/env_logger/):

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/Cargo.lock b/Cargo.lock
index 3309537..c604047 100644
--- a/Cargo.lock
+++ b/Cargo.lock

  *** Again, long diff output omitted here ***

diff --git a/Cargo.toml b/Cargo.toml
index da7f28c..fd43be7 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -9,3 +9,5 @@ edition = "2018"
 [dependencies]
 telnet = "*"
 regex = "*"
+env_logger = "*"
+log = "*"
diff --git a/src/main.rs b/src/main.rs
index 2b68265..e01dd87 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -1,5 +1,8 @@
 extern crate regex;
 extern crate telnet;
+extern crate env_logger;
+#[macro_use] extern crate log;
+
 use regex::Regex;
 use telnet::Telnet;
 
@@ -13,6 +16,7 @@ enum LoginState {
 }
 
 fn main() {
+    env_logger::init();
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
     let ts_netops_user = std::env::var("TS_NETOPS_USER").unwrap();
     let ts_netops_pass = std::env::var("TS_NETOPS_PASS").unwrap();
@@ -36,13 +40,12 @@ fn main() {
             TelnetEvent::Data(bytes) => {
                 let string = String::from_utf8_lossy(&bytes);
                 data_buffer.push_str(&string);
-                println!("State: {:?}. data buffer: '{}'", &login_state, &data_buffer);
+                trace!("State: {:?}. data buffer: '{}'", &login_state, &data_buffer);
                 match login_state {
                     LoginState::Initial => {
-                        println!("In initial state");
                         let maybe_user_match = username_regex.find(&data_buffer);
                         if let Some(user_match) = maybe_user_match {
-                            println!("Matched username prompt! Data buffer: {}", &data_buffer);
+                            debug!("Matched username prompt! Data buffer: {}", &data_buffer);
                             connection.write(&format!("{}\n", &ts_netops_user).as_bytes());
                             let (_, remainder) = data_buffer.split_at(user_match.end());
                             data_buffer = remainder.to_string();
@@ -52,7 +55,7 @@ fn main() {
                     LoginState::SentUsername => {
                         let maybe_password_match = password_regex.find(&data_buffer);
                         if let Some(password_match) = maybe_password_match {
-                            println!("Matched password prompt! Data buffer: {}", &data_buffer);
+                            debug!("Matched password prompt! Data buffer: {}", &data_buffer);
                             connection.write(&format!("{}\n", &ts_netops_pass).as_bytes());
                             let (_, remainder) = data_buffer.split_at(password_match.end());
                             data_buffer = remainder.to_string();
@@ -62,7 +65,7 @@ fn main() {
                     LoginState::SentPassword => {
                         let maybe_privexec_match = privexec_regex.find(&data_buffer);
                         if let Some(privexec_match) = maybe_privexec_match {
-                            println!("Matched privexec prompt! Session is open!");
+                            debug!("Matched privexec prompt! Session is open!");
                             let (_, remainder) = data_buffer.split_at(privexec_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::Established;
@@ -71,16 +74,16 @@ fn main() {
                         }
                     }
                     _ => {
-                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
+                        debug!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
                 }
             }
             _ => {
-                println!("{:?}", &event);
+                debug!("{:?}", &event);
             }
         }
     }
-    println!("Showtime!");
+    debug!("Showtime!");
     connection.write(b"term len 0\n");
     login_state = LoginState::ReadingOutput;
 
@@ -95,7 +98,7 @@ fn main() {
                     LoginState::ReadingOutput => {
                         let maybe_privexec_match = privexec_regex.find(&data_buffer);
                         if let Some(privexec_match) = maybe_privexec_match {
-                            println!("Matched privexec prompt! Data buffer: {}", &data_buffer);
+                            debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
                             let (_, remainder) = data_buffer.split_at(privexec_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::Established;
@@ -104,12 +107,12 @@ fn main() {
 
                     }
                     _ => {
-                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
+                        debug!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
                 }
             }
             _ => {
-                println!("{:?}", &event);
+                debug!("{:?}", &event);
             }
         }
     }
@@ -128,7 +131,7 @@ fn main() {
                     LoginState::ReadingOutput => {
                         let maybe_privexec_match = privexec_regex.find(&data_buffer);
                         if let Some(privexec_match) = maybe_privexec_match {
-                            println!("Matched privexec prompt! Data buffer: {}", &data_buffer);
+                            debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
                             let (_, remainder) = data_buffer.split_at(privexec_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::Established;
@@ -137,12 +140,12 @@ fn main() {
 
                     }
                     _ => {
-                        println!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
+                        debug!("Other state: {:?}. data buffer: {}", &login_state, &data_buffer);
                     }
                 }
             }
             _ => {
-                println!("{:?}", &event);
+                debug!("{:?}", &event);
             }
         }
     }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Use debug!() for debugging instead println!()"
[master 3ce3fd1] Use debug!() for debugging instead println!()
 3 files changed, 130 insertions(+), 14 deletions(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 

```

when we do "cargo build" and run the result, we will see it has
become totally quiet:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

But the debugs are still there if we need them:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "who"
[2020-05-17T16:42:37Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T16:42:37Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T16:42:37Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T16:42:37Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T16:42:47Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T16:42:47Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T16:42:57Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T16:42:57Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T16:42:57Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    003-X03-S0457#
[2020-05-17T16:42:57Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: who
        Line       User       Host(s)              Idle       Location
    *  1 vty 0     ay         idle                 00:00:00 192.168.42.209
    
      Interface    User               Mode         Idle     Peer Address
    
    003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Note how now we are also getting the timestamps and the module name.
That is a nice freebie!

Now, before going further, let's get rid of at least some of the warnings.
We will do so, much like in our first SSH portion, in a manner
that will be obvious and will cause easy to debug failure
if there is an error:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index e01dd87..d1c2f90 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -46,7 +46,7 @@ fn main() {
                         let maybe_user_match = username_regex.find(&data_buffer);
                         if let Some(user_match) = maybe_user_match {
                             debug!("Matched username prompt! Data buffer: {}", &data_buffer);
-                            connection.write(&format!("{}\n", &ts_netops_user).as_bytes());
+                            connection.write(&format!("{}\n", &ts_netops_user).as_bytes()).unwrap();
                             let (_, remainder) = data_buffer.split_at(user_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::SentUsername;
@@ -56,7 +56,7 @@ fn main() {
                         let maybe_password_match = password_regex.find(&data_buffer);
                         if let Some(password_match) = maybe_password_match {
                             debug!("Matched password prompt! Data buffer: {}", &data_buffer);
-                            connection.write(&format!("{}\n", &ts_netops_pass).as_bytes());
+                            connection.write(&format!("{}\n", &ts_netops_pass).as_bytes()).unwrap();
                             let (_, remainder) = data_buffer.split_at(password_match.end());
                             data_buffer = remainder.to_string();
                             login_state = LoginState::SentPassword;
@@ -84,7 +84,7 @@ fn main() {
         }
     }
     debug!("Showtime!");
-    connection.write(b"term len 0\n");
+    connection.write(b"term len 0\n").unwrap();
     login_state = LoginState::ReadingOutput;
 
     loop {
@@ -117,7 +117,7 @@ fn main() {
         }
     }
 
-    connection.write(&format!("{}\n", command_to_run).as_bytes());
+    connection.write(&format!("{}\n", command_to_run).as_bytes()).unwrap();
     login_state = LoginState::ReadingOutput;
 
     loop {
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Stop some of the warnings (panic on error)"
[master ff77557] Stop some of the warnings (panic on error)
 1 file changed, 4 insertions(+), 4 deletions(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Now let's add the means to accumulate and print the output
of the command even if the debugs are off:

ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index d1c2f90..81a0c5f 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -119,6 +119,7 @@ fn main() {
 
     connection.write(&format!("{}\n", command_to_run).as_bytes()).unwrap();
     login_state = LoginState::ReadingOutput;
+    let mut result = "".to_string();
 
     loop {
         use telnet::TelnetEvent;
@@ -132,8 +133,9 @@ fn main() {
                         let maybe_privexec_match = privexec_regex.find(&data_buffer);
                         if let Some(privexec_match) = maybe_privexec_match {
                             debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
-                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            let (command_output, remainder) = data_buffer.split_at(privexec_match.end());
                             data_buffer = remainder.to_string();
+                            result = command_output.to_string();
                             login_state = LoginState::Established;
                             break;
                         }
@@ -149,4 +151,5 @@ fn main() {
             }
         }
     }
+    println!("Result: {}", &result);
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

However, attempting to build this code,
we hit an error:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
   Compiling ts-netops-simple-telnet v0.1.0 (/home/ubuntu/ts-netops-simple-telnet)
.....
error[E0506]: cannot assign to `data_buffer` because it is borrowed
   --> src/main.rs:137:29
    |
136 | ...                   let (command_output, remainder) = data_buffer.split_at(privexec_match.end());
    |                                                         ----------- borrow of `data_buffer` occurs here
137 | ...                   data_buffer = remainder.to_string();
    |                       ^^^^^^^^^^^ assignment to borrowed `data_buffer` occurs here
138 | ...                   result = command_output.to_string();
    |                                -------------- borrow later used here

error: aborting due to previous error

For more information about this error, try `rustc --explain E0506`.
error: could not compile `ts-netops-simple-telnet`.

To learn more, run the command again with --verbose.
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Meet borrowchecker - your best guardian angel that will help you
not make the mistakes, as much as it might be annoying when you
come from other languages.

What is the problem here ? The split_at command borrows the data_buffer,
returning what is two refereces to its contents. 
Rust detects that we are attempting
to use one of the references after we have modified the buffer.
Good catch! Fortunately, it is easy to fix the problem in this case:
just swap the two assignments:

ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index d1c2f90..bffce89 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -119,6 +119,7 @@ fn main() {
 
     connection.write(&format!("{}\n", command_to_run).as_bytes()).unwrap();
     login_state = LoginState::ReadingOutput;
+    let mut result = "".to_string();
 
     loop {
         use telnet::TelnetEvent;
@@ -132,7 +133,8 @@ fn main() {
                         let maybe_privexec_match = privexec_regex.find(&data_buffer);
                         if let Some(privexec_match) = maybe_privexec_match {
                             debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
-                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            let (command_output, remainder) = data_buffer.split_at(privexec_match.end());
+                            result = command_output.to_string();
                             data_buffer = remainder.to_string();
                             login_state = LoginState::Established;
                             break;
@@ -149,4 +151,5 @@ fn main() {
             }
         }
     }
+    println!("Result: {}", &result);
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$   
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Collect the command output"
[master dc359f7] Collect the command output
 1 file changed, 4 insertions(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
Result: who
    Line       User       Host(s)              Idle       Location
*  1 vty 0     ay         idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

After this run, let's run the "cargo fmt" to ensure the uniform format
of our code... Ideally we would run it on every check-in, but that
is something that we will take care of another tutorial.

I will omit the diff here, since it is not very interesting..

Now we will deal with the fixing the functionality of this code. However,
before then - let's slightly extend it, iterating over all of the commands
that were supplied as parameters, rather than one. This way we can
use the command to reconfigure the device into the state where we
will need to fix the code in order to be able to login again.


```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 2189845..eb71d50 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -21,7 +21,6 @@ fn main() {
     let ts_netops_host = std::env::var("TS_NETOPS_HOST").unwrap();
     let ts_netops_user = std::env::var("TS_NETOPS_USER").unwrap();
     let ts_netops_pass = std::env::var("TS_NETOPS_PASS").unwrap();
-    let command_to_run = std::env::args().nth(1).unwrap();
 
     let tcp_target = format!("{}:23", ts_netops_host);
 
@@ -127,44 +126,46 @@ fn main() {
         }
     }
 
-    connection
-        .write(&format!("{}\n", command_to_run).as_bytes())
-        .unwrap();
-    login_state = LoginState::ReadingOutput;
-    let mut result = "".to_string();
+    for command_to_run in std::env::args().skip(1) {
+        connection
+            .write(&format!("{}\n", command_to_run).as_bytes())
+            .unwrap();
+        login_state = LoginState::ReadingOutput;
+        let mut result = "".to_string();
 
-    loop {
-        use telnet::TelnetEvent;
-        let event = connection.read().expect("Read Error");
-        match &event {
-            TelnetEvent::Data(bytes) => {
-                let string = String::from_utf8_lossy(&bytes);
-                data_buffer.push_str(&string);
-                match login_state {
-                    LoginState::ReadingOutput => {
-                        let maybe_privexec_match = privexec_regex.find(&data_buffer);
-                        if let Some(privexec_match) = maybe_privexec_match {
-                            debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
-                            let (command_output, remainder) =
-                                data_buffer.split_at(privexec_match.end());
-                            result = command_output.to_string();
-                            data_buffer = remainder.to_string();
-                            login_state = LoginState::Established;
-                            break;
+        loop {
+            use telnet::TelnetEvent;
+            let event = connection.read().expect("Read Error");
+            match &event {
+                TelnetEvent::Data(bytes) => {
+                    let string = String::from_utf8_lossy(&bytes);
+                    data_buffer.push_str(&string);
+                    match login_state {
+                        LoginState::ReadingOutput => {
+                            let maybe_privexec_match = privexec_regex.find(&data_buffer);
+                            if let Some(privexec_match) = maybe_privexec_match {
+                                debug!("Matched privexec prompt! Data buffer: {}", &data_buffer);
+                                let (command_output, remainder) =
+                                    data_buffer.split_at(privexec_match.end());
+                                result = command_output.to_string();
+                                data_buffer = remainder.to_string();
+                                login_state = LoginState::Established;
+                                break;
+                            }
+                        }
+                        _ => {
+                            debug!(
+                                "Other state: {:?}. data buffer: {}",
+                                &login_state, &data_buffer
+                            );
                         }
-                    }
-                    _ => {
-                        debug!(
-                            "Other state: {:?}. data buffer: {}",
-                            &login_state, &data_buffer
-                        );
                     }
                 }
-            }
-            _ => {
-                debug!("{:?}", &event);
+                _ => {
+                    debug!("{:?}", &event);
+                }
             }
         }
+        println!("Result: {}", &result);
     }
-    println!("Result: {}", &result);
 }
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Execute each of the command line arguments"
[master 1c32054] Execute each of the command line arguments
 1 file changed, 35 insertions(+), 34 deletions(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Seemingly there is a lot going on - but, all that we have done
is enclose the previously linear block into a loop that iterates
over all the command line arguments, skipping the very first
(which is the argv[0], the name of the command itself) 

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who" "show clock"
Result: who
    Line       User       Host(s)              Idle       Location
*  1 vty 0     ay         idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
Result: show clock
Load for five secs: 22%/0%; one minute: 22%; five minutes: 22%
Time source is NTP, 19:36:33.829 CET Thu Jul 8 1915

19:36:33.829 CET Thu Jul 8 1915
003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

(Oops, you can see the NTP does need to be setup there ! :)
Let's try changing the hostname first:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "conf t" "hostname TEST-003-X03-S0457" "end"
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Notice the connection hangs... Let's debug it...

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "conf t" "hostname TEST-003-X03-S0457" "end"
[2020-05-17T17:23:50Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:23:50Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:23:50Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:23:50Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:24:00Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:24:00Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:24:10Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:24:10Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:24:10Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    003-X03-S0457#

```

So we get to the state where we are sending the first command,
but we are never matching on the exec prompt... Well, rightly so -
because it is now a config mode prompt, which has parentheses!

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "conf t" "hostname TEST-003-X03-S0457" "end"
[2020-05-17T17:26:30Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:26:30Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:26:30Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:26:30Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:26:40Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:26:40Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    003-X03-S0457#
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: conf t
    Enter configuration commands, one per line.  End with CNTL/Z.
    003-X03-S0457(config)#
Result: conf t
Enter configuration commands, one per line.  End with CNTL/Z.
003-X03-S0457(config)#
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: hostname TEST-003-X03-S0457
    TEST-003-X03-S0457(config)#
Result: hostname TEST-003-X03-S0457
TEST-003-X03-S0457(config)#
[2020-05-17T17:26:50Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: end
    TEST-003-X03-S0457#
Result: end
TEST-003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index eb71d50..7ee5022 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -31,7 +31,7 @@ fn main() {
     let mut login_state = LoginState::Initial;
     let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
     let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
-    let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z]+)#").unwrap();
+    let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z()]+)#").unwrap();
 
     loop {
         use telnet::TelnetEvent;
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Make privexec prompt match in config mode too"
[master 4dc7bf1] Make privexec prompt match in config mode too
 1 file changed, 1 insertion(+), 1 deletion(-)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Now, given that we are going to change the aaa configuration - would it
not be nice to be able to issue "reload in 5" command - so as not to go
and reload the box manually if we lock ourselves out ?

If we attempt to give this command, we notice we are lacking some debug outputs... So let's add them:


```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 7ee5022..fe2fc01 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -140,6 +140,7 @@ fn main() {
                 TelnetEvent::Data(bytes) => {
                     let string = String::from_utf8_lossy(&bytes);
                     data_buffer.push_str(&string);
+                    debug!("Got output:'{}'", &string);
                     match login_state {
                         LoginState::ReadingOutput => {
                             let maybe_privexec_match = privexec_regex.find(&data_buffer);
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Debug-print the in-progress command output"
[master 0fcd135] Debug-print the in-progress command output
 1 file changed, 1 insertion(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

This allows us to see what is the problem with the command:


```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "reload in 5" ""
[2020-05-17T17:39:55Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:39:55Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:39:55Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:39:55Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: TEST-003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    TEST-003-X03-S0457#
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Got output:'eload'
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Got output:'in '
[2020-05-17T17:40:05Z DEBUG ts_netops_simple_telnet] Got output:'5
    
    System configuration has been modified. Save? [yes/no]: '

```

Remember, we changed the hostname ? 
We are at a point where we will need to think what to do 
with the interactive prompts...
In principle, we can add more regex matching and more parameters,
but to make this tutorial not too long, we will take a shortcut:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index fe2fc01..de05ab4 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -127,6 +127,7 @@ fn main() {
     }
 
     for command_to_run in std::env::args().skip(1) {
+        let command_to_run = command_to_run.replace("\\n", "\n");
         connection
             .write(&format!("{}\n", command_to_run).as_bytes())
             .unwrap();
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "reload in 5\nn" ""
[2020-05-17T17:42:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:42:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:42:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:42:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:43:09Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: TEST-003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:43:09Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    TEST-003-X03-S0457#
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'eload '
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'n '
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'5
    '
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'
    System configuration has been modified. Save? [yes/no]: '
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T17:43:19Z DEBUG ts_netops_simple_telnet] Got output:'
    Reload scheduled for 20:04:31 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty0 (192.168.42.209)
    Proceed with reload? [confirm]'
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$
```

Progress!

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "reload in 5\nn\n" "reload cancel"
[2020-05-17T17:45:25Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:45:25Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:45:25Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:45:25Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:45:35Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: TEST-003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:45:35Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    TEST-003-X03-S0457#
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'l'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'ad '
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:' 5'
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'
    '
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'
    System configuration has been modified. Save? [yes/no]: '
[2020-05-17T17:45:45Z DEBUG ts_netops_simple_telnet] Got output:'n
    Reload scheduled for 20:06:57 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty0 (192.168.42.209)
    Proceed with reload? [confirm]'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'
    
    TEST-003-X03-S0457#'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: reload in 5
    
    System configuration has been modified. Save? [yes/no]: n
    Reload scheduled for 20:06:57 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty0 (192.168.42.209)
    Proceed with reload? [confirm]
    
    TEST-003-X03-S0457#
Result: reload in 5

System configuration has been modified. Save? [yes/no]: n
Reload scheduled for 20:06:57 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty0 (192.168.42.209)
Proceed with reload? [confirm]

TEST-003-X03-S0457#
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'lo'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'d '
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'c'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'an'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'cel
    '
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Got output:'TEST-003-X03-S0457#'
[2020-05-17T17:45:46Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: reload cancel
    TEST-003-X03-S0457#
Result: reload cancel
TEST-003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Allow embedding the newlines as part of the single command run"
[master a95db22] Allow embedding the newlines as part of the single command run
 1 file changed, 1 insertion(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Excellent, it works!


Let's refresh our memory on AAA configuration:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "show run aaa"
Result: show run aaa
Load for five secs: 22%/0%; one minute: 23%; five minutes: 23%
Time source is NTP, 20:08:17.796 CET Thu Jul 8 1915
!
aaa authentication login default group ACS local
aaa authentication login CONSOLE local
aaa authentication enable default group ACS enable
aaa authorization exec default group ACS local 
username ay privilege 15 password 7 14141B180F0B7B7977
!
!
!
!
!
!
!
!
aaa group server tacacs+ ACS
 server-private 10.100.253.7 key some-key-edited
 server-private 10.100.253.107 key some-key-edited
 ip tacacs source-interface Loopback0
!
!
aaa new-model
aaa session-id common
!
!

TEST-003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Let's try disabling the authentication:

```
TEST-003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "conf t" "aaa authentication login default none" "end" "reload in 5\nn\n" 
[2020-05-17T17:54:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:54:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:54:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:54:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:55:09Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: TEST-003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T17:55:09Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    TEST-003-X03-S0457#
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'c'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'nf'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'t
    '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'Enter configuration commands, one per line.  End with CNTL/Z.
    TEST-003-X03-S0457(config)#'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: conf t
    Enter configuration commands, one per line.  End with CNTL/Z.
    TEST-003-X03-S0457(config)#
Result: conf t
Enter configuration commands, one per line.  End with CNTL/Z.
TEST-003-X03-S0457(config)#
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'aa'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'a authentication login default none
    TEST-003-X03-S0457(config)#'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: aaa authentication login default none
    TEST-003-X03-S0457(config)#
Result: aaa authentication login default none
TEST-003-X03-S0457(config)#
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'d'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'
    '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'TEST-003-X03-S0457#'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: end
    TEST-003-X03-S0457#
Result: end
TEST-003-X03-S0457#
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'l'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'d'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'5'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'
    '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'
    System configuration has been modified. Save? [yes/no]: '
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'
    Reload scheduled for 20:16:31 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
    Proceed with reload? [confirm]'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Got output:'
    
    TEST-003-X03-S0457#'
[2020-05-17T17:55:19Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: reload in 5
    
    System configuration has been modified. Save? [yes/no]: n
    Reload scheduled for 20:16:31 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
    Proceed with reload? [confirm]
    
    TEST-003-X03-S0457#
Result: reload in 5

System configuration has been modified. Save? [yes/no]: n
Reload scheduled for 20:16:31 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
Proceed with reload? [confirm]

TEST-003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 

```

ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace ./target/debug/ts-netops-simple-telnet "show run aaa"
[2020-05-17T17:55:53Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:55:53Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:55:53Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:55:53Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:55:53Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: '% Authorization failed.
    '
[2020-05-17T17:55:54Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: '% Authorization failed.
    
    
    
    ***
    *** --- SHUTDOWN in 0:05:00 ---
    ***
    '
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

This is a fatal error, so let's add a panic for it for now, and wait 
till our "reload in 5" takes effect...

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index de05ab4..1d763ff 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -31,6 +31,7 @@ fn main() {
     let mut login_state = LoginState::Initial;
     let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
     let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
+    let author_failed_regex = Regex::new(r"(?m)^% Authorization failed.").unwrap();
     let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z()]+)#").unwrap();
 
     loop {
@@ -53,6 +54,9 @@ fn main() {
                             data_buffer = remainder.to_string();
                             login_state = LoginState::SentUsername;
                         }
+                        if let Some(author_failed_match) = author_failed_regex.find(&data_buffer) {
+                            panic!("Authorization failed!");
+                        }
                     }
                     LoginState::SentUsername => {
                         let maybe_password_match = password_regex.find(&data_buffer);
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Panic if author failed in initial state"
[master 6ff9258] Panic if author failed in initial state
 1 file changed, 4 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace ./target/debug/ts-netops-simple-telnet "show run aaa"
[2020-05-17T17:59:51Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T17:59:51Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T17:59:51Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T17:59:51Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T17:59:51Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: '% Authorization failed.
    '
thread 'main' panicked at 'Authorization failed!', src/main.rs:58:29
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

While the switch is reloading, we can verify that our toy telnet client
is correctly giving us error in case we try to connect:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace ./target/debug/ts-netops-simple-telnet "show run aaa"
thread 'main' panicked at 'Couldn't connect to the server...: Custom { kind: Other, error: "failed to lookup address information: Name or service not known" }', src/main.rs:28:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace TS_NETOPS_HOST=192.168.42.167 ./target/debug/ts-netops-simple-telnet "show run aaa"
thread 'main' panicked at 'Couldn't connect to the server...: Os { code: 113, kind: Other, message: "No route to host" }', src/main.rs:28:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

When the device comes back up, let's attempt to reconfigure it again, this time also disabling the authorization as well.

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "conf t" "aaa authorization exec default none" "aaa authentication login default none" "end" "reload in 5\nn\n" 
[2020-05-17T18:12:52Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T18:12:52Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T18:12:52Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T18:12:52Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T18:13:02Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T18:13:02Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay
    Password: 
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Session is open!
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Showtime!
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: term len 0
    003-X03-S0457#
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'c'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'f t'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'
    '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'Enter configuration commands, one per line.  End with CNTL/Z.
    003-X03-S0457(config)#'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: conf t
    Enter configuration commands, one per line.  End with CNTL/Z.
    003-X03-S0457(config)#
Result: conf t
Enter configuration commands, one per line.  End with CNTL/Z.
003-X03-S0457(config)#
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'aa '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'authoriz'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ation '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'exec'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:' d'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'fa'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ul'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'t'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'e
    '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'003-X03-S0457(config)#'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: aaa authorization exec default none
    003-X03-S0457(config)#
Result: aaa authorization exec default none
003-X03-S0457(config)#
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:' a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'u'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'th'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'nt'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ca'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ti'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'on'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:' l'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'g'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'d'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ef'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'u'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'lt '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'ne'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'
    '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'003-X03-S0457(config)#'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: aaa authentication login default none
    003-X03-S0457(config)#
Result: aaa authentication login default none
003-X03-S0457(config)#
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'d
    '
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'003-X03-S0457#'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: end
    003-X03-S0457#
Result: end
003-X03-S0457#
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'r'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'e'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'l'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'o'
[2020-05-17T18:13:12Z DEBUG ts_netops_simple_telnet] Got output:'a'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'d'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'i'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:' '
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'5'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'
    
    System configuration has been modified. Save? [yes/no]: '
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'n'
[2020-05-17T18:13:13Z DEBUG ts_netops_simple_telnet] Got output:'
    Reload scheduled for 20:34:22 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
    Proceed with reload? [confirm]'
[2020-05-17T18:13:14Z DEBUG ts_netops_simple_telnet] Got output:'
    
    003-X03-S0457#'
[2020-05-17T18:13:14Z DEBUG ts_netops_simple_telnet] Matched privexec prompt! Data buffer: reload in 5
    
    System configuration has been modified. Save? [yes/no]: n
    Reload scheduled for 20:34:22 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
    Proceed with reload? [confirm]
    
    003-X03-S0457#
Result: reload in 5

System configuration has been modified. Save? [yes/no]: n
Reload scheduled for 20:34:22 CET Thu Jul 8 1915 (in 5 minutes) by ay on vty1 (192.168.42.209)
Proceed with reload? [confirm]

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace TS_NETOPS_HOST=192.168.42.167 ./target/debug/ts-netops-simple-telnet "show run aaa"
[2020-05-17T18:13:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T18:13:59Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T18:13:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T18:13:59Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T18:13:59Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: '
    003-X03-S0457#'
^C
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 

```

We need to add transition from the initial state to the opened connection.

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 1d763ff..6beb4e1 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -57,6 +57,14 @@ fn main() {
                         if let Some(author_failed_match) = author_failed_regex.find(&data_buffer) {
                             panic!("Authorization failed!");
                         }
+                        if let Some(privexec_match) = privexec_regex.find(&data_buffer) {
+                            debug!("Matched privexec prompt! Session is open!");
+                            let (_, remainder) = data_buffer.split_at(privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::Established;
+                            /* Session established */
+                            break;
+                        }
                     }
                     LoginState::SentUsername => {
                         let maybe_password_match = password_regex.find(&data_buffer);
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
Result: who
    Line       User       Host(s)              Idle       Location
   1 vty 0     ay         idle                 00:02:18 192.168.42.209
*  2 vty 1                idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Add transition Initial -> Established"
[master 409f6ff] Add transition Initial -> Established
 1 file changed, 8 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Let's reconfigure to use line password:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "conf t" "aaa authen login default line" "line vty 0 4" "password cisco123" "end"
Result: conf t
Enter configuration commands, one per line.  End with CNTL/Z.
003-X03-S0457(config)#
Result: aaa authen login default line
003-X03-S0457(config)#
Result: line vty 0 4
003-X03-S0457(config-line)#
Result: password cisco123
003-X03-S0457(config-line)#
Result: end
003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace ./target/debug/ts-netops-simple-telnet "who"
[2020-05-17T18:19:14Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T18:19:14Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T18:19:14Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T18:19:14Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T18:19:14Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: 'C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED    '
[2020-05-17T18:19:14Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: 'C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be'
[2020-05-17T18:19:14Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: 'C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ################################################'
[2020-05-17T18:19:14Z TRACE ts_netops_simple_telnet] State: Initial. data buffer: 'C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Password: '

ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 6beb4e1..7161415 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -65,6 +65,15 @@ fn main() {
                             /* Session established */
                             break;
                         }
+                        if let Some(password_match) = password_regex.find(&data_buffer) {
+                            debug!("Matched password prompt! Data buffer: {}", &data_buffer);
+                            connection
+                                .write(&format!("{}\n", &ts_netops_pass).as_bytes())
+                                .unwrap();
+                            let (_, remainder) = data_buffer.split_at(password_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::SentPassword;
+                        }
                     }
                     LoginState::SentUsername => {
                         let maybe_password_match = password_regex.find(&data_buffer);
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
Result: who
    Line       User       Host(s)              Idle       Location
   1 vty 0     ay         idle                 00:02:59 192.168.42.209
*  2 vty 1                idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ commig -a -m "Add transition Initial -> SentPassword"
commig: command not found
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Add transition Initial -> SentPassword"
[master f667b75] Add transition Initial -> SentPassword
 1 file changed, 9 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 

```

Let's make it such that we drop into non-privileged prompt, fix
this behavior and verify:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "conf t" "enable secret cisco123" "line vty 0 5" "privilege level 1" "end"
Result: conf t
Enter configuration commands, one per line.  End with CNTL/Z.
003-X03-S0457(config)#
Result: enable secret cisco123
003-X03-S0457(config)#
Result: line vty 0 5
003-X03-S0457(config-line)#
Result: privilege level 1
003-X03-S0457(config-line)#
Result: end
003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 7161415..6d4f568 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -13,6 +13,7 @@ enum LoginState {
     SentUsername,
     SentPassword,
     Established,
+    EstablishedNonPriv,
     ReadingOutput,
 }
 
@@ -33,6 +34,7 @@ fn main() {
     let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
     let author_failed_regex = Regex::new(r"(?m)^% Authorization failed.").unwrap();
     let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z()]+)#").unwrap();
+    let non_privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z]+)>").unwrap();
 
     loop {
         use telnet::TelnetEvent;
@@ -65,6 +67,13 @@ fn main() {
                             /* Session established */
                             break;
                         }
+                        if let Some(non_privexec_match) = non_privexec_regex.find(&data_buffer) {
+                            debug!("Matched non-privexec prompt! Need to enable!");
+                            let (_, remainder) = data_buffer.split_at(non_privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            connection.write(b"enable\n").unwrap();
+                            login_state = LoginState::Initial;
+                        }
                         if let Some(password_match) = password_regex.find(&data_buffer) {
                             debug!("Matched password prompt! Data buffer: {}", &data_buffer);
                             connection
@@ -97,6 +106,13 @@ fn main() {
                             /* Session established */
                             break;
                         }
+                        if let Some(non_privexec_match) = non_privexec_regex.find(&data_buffer) {
+                            debug!("Matched non-privexec prompt! Need to enable!");
+                            let (_, remainder) = data_buffer.split_at(non_privexec_match.end());
+                            data_buffer = remainder.to_string();
+                            connection.write(b"enable\n").unwrap();
+                            login_state = LoginState::Initial;
+                        }
                     }
                     _ => {
                         debug!(
ubuntu@ts-netops:~/ts-netops-simple-telnet$ ./target/debug/ts-netops-simple-telnet "who"
Result: who
    Line       User       Host(s)              Idle       Location
   1 vty 0     ay         idle                 00:00:29 192.168.42.209
*  2 vty 1                idle                 00:00:00 192.168.42.209

  Interface    User               Mode         Idle     Peer Address

003-X03-S0457#
ubuntu@ts-netops:~/ts-netops-simple-telnet$ cargo build
warning: unused variable: `author_failed_match`
  --> src/main.rs:59:37
   |
59 |                         if let Some(author_failed_match) = author_failed_regex.find(&data_buffer) {
   |                                     ^^^^^^^^^^^^^^^^^^^ help: consider prefixing with an underscore: `_author_failed_match`
   |
   = note: `#[warn(unused_variables)]` on by default

warning: value assigned to `login_state` is never read
  --> src/main.rs:66:29
   |
66 | ...                   login_state = LoginState::Established;
   |                       ^^^^^^^^^^^
   |
   = note: `#[warn(unused_assignments)]` on by default
   = help: maybe it is overwritten before being read?

warning: value assigned to `login_state` is never read
   --> src/main.rs:105:29
    |
105 | ...                   login_state = LoginState::Established;
    |                       ^^^^^^^^^^^
    |
    = help: maybe it is overwritten before being read?

warning: value assigned to `login_state` is never read
   --> src/main.rs:148:29
    |
148 | ...                   login_state = LoginState::Established;
    |                       ^^^^^^^^^^^
    |
    = help: maybe it is overwritten before being read?

warning: value assigned to `result` is never read
   --> src/main.rs:172:17
    |
172 |         let mut result = "".to_string();
    |                 ^^^^^^
    |
    = help: maybe it is overwritten before being read?

warning: value assigned to `login_state` is never read
   --> src/main.rs:191:33
    |
191 | ...                   login_state = LoginState::Established;
    |                       ^^^^^^^^^^^
    |
    = help: maybe it is overwritten before being read?

warning: variant is never constructed: `EstablishedNonPriv`
  --> src/main.rs:16:5
   |
16 |     EstablishedNonPriv,
   |     ^^^^^^^^^^^^^^^^^^
   |
   = note: `#[warn(dead_code)]` on by default

    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Add EstablishedNonPriv state and transitions"
[master 070f7ea] Add EstablishedNonPriv state and transitions
 1 file changed, 16 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

Now let's reload the switch and see what happens if we supply invalid
username:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ RUST_LOG=trace ./target/debug/ts-netops-simple-telnet "who"
[2020-05-17T18:39:36Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T18:39:36Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T18:39:36Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T18:39:36Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
....
[2020-05-17T18:39:46Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T18:39:46Z TRACE ts_netops_simple_telnet] State: SentUsername. data buffer: ' a'
[2020-05-17T18:39:46Z TRACE ts_netops_simple_telnet] State: SentUsername. data buffer: ' ay'
[2020-05-17T18:39:46Z TRACE ts_netops_simple_telnet] State: SentUsername. data buffer: ' ay1
    Password: '
[2020-05-17T18:39:46Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  ay1
    Password: 
[2020-05-17T18:40:00Z TRACE ts_netops_simple_telnet] State: SentPassword. data buffer: ' 
    
    % Authentication failed
    
    Username: '

```

Let's make sure this case gracefully fails:

```
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git diff
diff --git a/src/main.rs b/src/main.rs
index 6d4f568..e58f18c 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -33,6 +33,9 @@ fn main() {
     let username_regex = Regex::new(r"(?m)^[Uu]sername:").unwrap();
     let password_regex = Regex::new(r"(?m)^[Pp]assword:").unwrap();
     let author_failed_regex = Regex::new(r"(?m)^% Authorization failed.").unwrap();
+    let authen_failed_regex = Regex::new(r"(?m)^% Authentication failed").unwrap();
+    let mut authen_failed_count = 0;
+    let max_authen_failed_count = 2;
     let privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z()]+)#").unwrap();
     let non_privexec_regex = Regex::new(r"(?m)^([-_a-z0-9A-Z]+)>").unwrap();
 
@@ -113,6 +116,24 @@ fn main() {
                             connection.write(b"enable\n").unwrap();
                             login_state = LoginState::Initial;
                         }
+                        if let Some(authen_failed_match) = authen_failed_regex.find(&data_buffer) {
+                            debug!("Authentication failed!");
+                            authen_failed_count = authen_failed_count + 1;
+                            if authen_failed_count > max_authen_failed_count {
+                                panic!("Too many failed authentications!");
+                            }
+                            let (_, remainder) = data_buffer.split_at(authen_failed_match.end());
+                            data_buffer = remainder.to_string();
+                        }
+                        if let Some(user_match) = username_regex.find(&data_buffer) {
+                            debug!("Matched username prompt! Data buffer: {}", &data_buffer);
+                            connection
+                                .write(&format!("{}\n", &ts_netops_user).as_bytes())
+                                .unwrap();
+                            let (_, remainder) = data_buffer.split_at(user_match.end());
+                            data_buffer = remainder.to_string();
+                            login_state = LoginState::SentUsername;
+                        }
                     }
                     _ => {
                         debug!(
ubuntu@ts-netops:~/ts-netops-simple-telnet$ git commit -a -m "Handle failed authentications"
[master ecb1d4a] Handle failed authentications
 1 file changed, 21 insertions(+)
ubuntu@ts-netops:~/ts-netops-simple-telnet$ TS_NETOPS_USER=wrong RUST_LOG=debug ./target/debug/ts-netops-simple-telnet "who"
[2020-05-17T18:51:44Z DEBUG ts_netops_simple_telnet] Negotiation(Will, Echo)
[2020-05-17T18:51:44Z DEBUG ts_netops_simple_telnet] Negotiation(Will, SuppressGoAhead)
[2020-05-17T18:51:44Z DEBUG ts_netops_simple_telnet] Negotiation(Do, TTYPE)
[2020-05-17T18:51:44Z DEBUG ts_netops_simple_telnet] Negotiation(Do, NAWS)
[2020-05-17T18:51:55Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: C
    ##############################################################
    ##               Hostname: 003-X03-S0457                    ##
    ##                                                          ##
    ##          UNAUTHORIZED ACCESS IS PROHIBITED               ##
    ##                                                          ##
    ##     All sessions to this device are being monitored.     ##
    ##     If unauthorized access is detected, your address     ##
    ##     will be logged and the authorities will be           ##
    ##     notified to take appropriate actions.                ## 
    ##                                                          ##
    ##                                                          ##
    ##############################################################
    
    
    User Access Verification
    
    Username: 
[2020-05-17T18:51:55Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  wrong
    Password: 
[2020-05-17T18:51:59Z DEBUG ts_netops_simple_telnet] Authentication failed!
[2020-05-17T18:51:59Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: 
    
    Username: 
[2020-05-17T18:51:59Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  wrong
    Password: 
[2020-05-17T18:52:03Z DEBUG ts_netops_simple_telnet] Authentication failed!
[2020-05-17T18:52:03Z DEBUG ts_netops_simple_telnet] Matched username prompt! Data buffer: 
    
    Username: 
[2020-05-17T18:52:03Z DEBUG ts_netops_simple_telnet] Matched password prompt! Data buffer:  wrong
    Password: 
[2020-05-17T18:52:07Z DEBUG ts_netops_simple_telnet] Authentication failed!
thread 'main' panicked at 'Too many failed authentications!', src/main.rs:123:33
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
ubuntu@ts-netops:~/ts-netops-simple-telnet$ 
```

We still did not cover all of the erroneous cases,
but we at least fixed some basic issues.
But the code is getting unwieldy, and this tutorial too long -
so we will continue in another chapter...

The repository from this one is at https://github.com/ayourtch/ts-netops-simple-telnet




